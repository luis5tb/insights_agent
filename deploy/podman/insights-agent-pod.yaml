# Red Hat Insights Agent - Podman/Kubernetes Pod Configuration
#
# This pod deploys the complete Insights Agent stack:
#   - insights-agent: Main A2A agent (Gemini + Google ADK)
#   - insights-mcp: Red Hat Insights MCP server (tools for console.redhat.com)
#   - postgres: PostgreSQL database for persistence
#   - a2a-inspector: Web UI for interacting with the agent (optional)
#
# The agent passes Lightspeed credentials to the MCP server via HTTP headers,
# so the MCP server itself does not need the credentials configured.
# The agent connects to the MCP server over HTTP to access Insights tools
# (Advisor, Inventory, Vulnerability, etc.).
#
# Prerequisites (run from repository root):
#   1. Build the agent image: podman build -t localhost/insights-agent:latest -f Containerfile .
#   2. (Optional) Build the A2A Inspector image:
#        git clone https://github.com/a2aproject/a2a-inspector.git /tmp/a2a-inspector
#        podman build -t localhost/a2a-inspector:latest /tmp/a2a-inspector
#   3. Create config directory: mkdir -p config
#   4. Create and deploy secrets:
#      cp deploy/podman/insights-agent-secret.yaml deploy/podman/my-secrets.yaml
#      # Edit my-secrets.yaml with your credentials (plain text)
#      podman kube play deploy/podman/my-secrets.yaml
#
# Usage with Podman (from repository root):
#   podman kube play \
#     --configmap deploy/podman/insights-agent-configmap.yaml \
#     deploy/podman/insights-agent-pod.yaml
#
#   # View logs
#   podman logs insights-agent-pod-insights-agent
#   podman logs insights-agent-pod-insights-mcp
#
#   # Access A2A Inspector web UI at http://localhost:8080
#   # In the UI, enter http://localhost:8000 as the agent URL
#
# Usage with Kubernetes:
#   kubectl apply -f deploy/podman/my-secrets.yaml
#   kubectl apply -f deploy/podman/insights-agent-configmap.yaml
#   kubectl apply -f deploy/podman/insights-agent-pod.yaml
#
# Stop and remove resources:
#   podman kube down deploy/podman/insights-agent-pod.yaml
#   podman kube down deploy/podman/my-secrets.yaml
#
apiVersion: v1
kind: Pod
metadata:
  name: insights-agent-pod
  labels:
    app: insights-agent
spec:
  containers:
    # =========================================================================
    # Insights Agent - Main Application
    # =========================================================================
    - name: insights-agent
      image: localhost/insights-agent:latest
      envFrom:
        # Load configuration from ConfigMap
        - configMapRef:
            name: insights-agent-config
      env:
        # Vertex AI credentials path (if using Vertex AI)
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /config/vertex-credentials.json
        # Secrets loaded via secretKeyRef
        - name: GOOGLE_API_KEY
          valueFrom:
            secretKeyRef:
              name: insights-agent-secrets
              key: GOOGLE_API_KEY
        - name: GOOGLE_CLOUD_PROJECT
          valueFrom:
            secretKeyRef:
              name: insights-agent-secrets
              key: GOOGLE_CLOUD_PROJECT
              optional: true
        - name: RED_HAT_SSO_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: insights-agent-secrets
              key: RED_HAT_SSO_CLIENT_ID
        - name: RED_HAT_SSO_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: insights-agent-secrets
              key: RED_HAT_SSO_CLIENT_SECRET
        - name: LIGHTSPEED_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: insights-agent-secrets
              key: LIGHTSPEED_CLIENT_ID
        - name: LIGHTSPEED_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: insights-agent-secrets
              key: LIGHTSPEED_CLIENT_SECRET
      ports:
        - containerPort: 8000
          hostPort: 8000
      volumeMounts:
        - mountPath: /config:Z
          name: config
          readOnly: true

    # =========================================================================
    # Red Hat Insights MCP Server
    # =========================================================================
    # The MCP server provides tools for interacting with Red Hat Insights APIs.
    # Credentials are passed by the agent via HTTP headers, not environment variables.
    - name: insights-mcp
      image: quay.io/redhat-services-prod/insights-management-tenant/insights-mcp/red-hat-lightspeed-mcp:latest
      envFrom:
        # Load MCP server configuration from ConfigMap
        # Uses: MCP_SERVER_MODE, MCP_SERVER_PORT, MCP_SERVER_HOST
        - configMapRef:
            name: insights-agent-config
      args:
        - "$(MCP_SERVER_MODE)"
        - "--port"
        - "$(MCP_SERVER_PORT)"
        - "--host"
        - "$(MCP_SERVER_HOST)"
      ports:
        - containerPort: 8081
          hostPort: 8081

    # =========================================================================
    # PostgreSQL Database
    # =========================================================================
    - name: postgres
      image: registry.redhat.io/rhel9/postgresql-16:latest
      env:
        - name: POSTGRESQL_USER
          value: insights
        - name: POSTGRESQL_PASSWORD
          value: insights
        - name: POSTGRESQL_DATABASE
          value: insights_agent
      ports:
        - containerPort: 5432
          hostPort: 5432
      volumeMounts:
        - name: pgdata
          mountPath: /var/lib/pgsql/data:Z

    # =========================================================================
    # A2A Inspector - Web UI for Agent Interaction
    # =========================================================================
    # Provides a web interface to interact with the A2A agent, view agent cards,
    # validate spec compliance, and debug JSON-RPC 2.0 messages.
    # Access at http://localhost:8080 and connect to http://localhost:8000
    #
    # Build the inspector image first:
    #   git clone https://github.com/a2aproject/a2a-inspector.git /tmp/a2a-inspector
    #   podman build -t localhost/a2a-inspector:latest /tmp/a2a-inspector
    - name: a2a-inspector
      image: localhost/a2a-inspector:latest
      ports:
        - containerPort: 8080
          hostPort: 8080

  volumes:
    - name: config
      hostPath:
        path: ./config
        type: Directory
    - name: pgdata
      emptyDir: {}
      # Uncomment below and comment out emptyDir to persist data between pod restarts
      # hostPath:
      #   path: ./data/pgdata
      #   type: DirectoryOrCreate

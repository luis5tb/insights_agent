# Red Hat Insights Agent - Podman/Kubernetes Pod Configuration
#
# This pod deploys the complete Insights Agent stack:
#   - insights-agent: Main A2A agent (Gemini + Google ADK)
#   - insights-mcp: Red Hat Insights MCP server (tools for console.redhat.com)
#   - postgres: PostgreSQL database for persistence
#   - redis: Redis for rate limiting and caching
#
# The agent passes Lightspeed credentials to the MCP server via HTTP headers,
# so the MCP server itself does not need the credentials configured.
# The agent connects to the MCP server over HTTP to access Insights tools
# (Advisor, Inventory, Vulnerability, etc.).
#
# Prerequisites (run from repository root):
#   1. Build the agent image: podman build -t localhost/insights-agent:latest -f Containerfile .
#   2. Create config directory: mkdir -p config
#   3. Copy and edit the secret file:
#      cp deploy/podman/insights-agent-secret.yaml deploy/podman/my-secrets.yaml
#      Edit my-secrets.yaml with your actual credentials
#
# Usage with Podman (from repository root):
#   podman play kube \
#     --configmap deploy/podman/insights-agent-configmap.yaml \
#     --configmap deploy/podman/my-secrets.yaml \
#     deploy/podman/insights-agent-pod.yaml
#
#   # View logs
#   podman logs insights-agent-pod-insights-agent
#   podman logs insights-agent-pod-insights-mcp
#
# Usage with Kubernetes:
#   kubectl apply -f deploy/podman/insights-agent-configmap.yaml
#   kubectl create secret generic insights-agent-secrets --from-env-file=.env
#   kubectl apply -f deploy/podman/insights-agent-pod.yaml
#
# Stop the pod:
#   podman pod stop insights-agent-pod
#   podman pod rm insights-agent-pod
#
apiVersion: v1
kind: Pod
metadata:
  name: insights-agent-pod
  labels:
    app: insights-agent
spec:
  containers:
    # =========================================================================
    # Insights Agent - Main Application
    # =========================================================================
    - name: insights-agent
      image: localhost/insights-agent:latest
      envFrom:
        # Load configuration from ConfigMap
        - configMapRef:
            name: insights-agent-config
        # Load secrets from Secret
        - secretRef:
            name: insights-agent-secrets
      env:
        # Override: Vertex AI credentials path (if using Vertex AI)
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /config/vertex-credentials.json
      ports:
        - containerPort: 8000
          hostPort: 8000
      volumeMounts:
        - mountPath: /config:Z
          name: config
          readOnly: true

    # =========================================================================
    # Red Hat Insights MCP Server
    # =========================================================================
    # The MCP server provides tools for interacting with Red Hat Insights APIs.
    # Credentials are passed by the agent via HTTP headers, not environment variables.
    - name: insights-mcp
      image: quay.io/redhat-services-prod/insights-management-tenant/insights-mcp/red-hat-lightspeed-mcp:latest
      env:
        # MCP server mode: run as HTTP server for agent connection
        - name: MCP_SERVER_MODE
          value: "http"
        - name: MCP_SERVER_PORT
          value: "8080"
      ports:
        - containerPort: 8080
          hostPort: 8080

    # =========================================================================
    # PostgreSQL Database
    # =========================================================================
    - name: postgres
      image: registry.redhat.io/rhel9/postgresql-16:latest
      env:
        - name: POSTGRESQL_USER
          value: insights
        - name: POSTGRESQL_PASSWORD
          value: insights
        - name: POSTGRESQL_DATABASE
          value: insights_agent
      ports:
        - containerPort: 5432
          hostPort: 5432
      volumeMounts:
        - name: pgdata
          mountPath: /var/lib/pgsql/data:Z

    # =========================================================================
    # Redis (Rate Limiting and Caching)
    # =========================================================================
    - name: redis
      image: registry.redhat.io/rhel9/redis-7:latest
      env:
        - name: REDIS_PASSWORD
          value: ""
      ports:
        - containerPort: 6379
          hostPort: 6379
      volumeMounts:
        - name: redisdata
          mountPath: /var/lib/redis/data:Z

  volumes:
    - name: config
      hostPath:
        path: ./config
        type: Directory
    - name: pgdata
      emptyDir: {}
      # Uncomment below and comment out emptyDir to persist data between pod restarts
      # hostPath:
      #   path: ./data/pgdata
      #   type: DirectoryOrCreate
    - name: redisdata
      emptyDir: {}
      # Uncomment below and comment out emptyDir to persist data between pod restarts
      # hostPath:
      #   path: ./data/redisdata
      #   type: DirectoryOrCreate
